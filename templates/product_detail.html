{% extends "base.html" %}
{% load static %}
{% load store_tags %}



{% block title %}{{ product.name }} - LeatherCraft{% endblock %}

{% block content %}
    <section class="product-detail">
        <div class="container">
            <!-- Breadcrumbs -->
            <nav class="breadcrumbs">
                <a href="{% url 'store:index' %}">Главная</a>
                <span>/</span>
                <a href="{% url 'store:catalog' %}">Каталог</a>
                {% if product.category %}
                    <span>/</span>
                    <a href="{% url 'store:catalog' %}?category={{ product.category.slug }}">{{ product.category.name }}</a>
                {% endif %}
                <span>/</span>
                <span>{{ product.name }}</span>
            </nav>

            <div class="product-detail-content">
                <!-- Product Images -->
                <div class="product-images">
                    <div class="main-image">
                        <img src="{% get_main_image product %}"
                             alt="{{ product.name }}" id="mainProductImage">
                    </div>
                    {% if product.images|length > 1 %}
                        <div class="thumbnail-images">
                            {% for image in product.images %}
                                <img src="{{ image.url }}" alt="{{ product.name }}"
                                     class="thumbnail {% if loop.first %}active{% endif %}"
                                     onclick="changeMainImage('{{ image.url }}', this)">
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Product Info -->
                <div class="product-info">
                    <h1>{{ product.name }}</h1>

                    <div class="product-price">
                        {% if product.discount_price %}
                            <span class="current-price">{{ product.discount_price|currency }}</span>
                            <span class="old-price">{{ product.price|currency }}</span>
                            <span class="discount-badge">-{{ product.discount_percentage }}%</span>
                        {% else %}
                            <span class="current-price">{{ product.price|currency }}</span>
                        {% endif %}
                    </div>

                    <div class="product-description">
                        {{ product.description|safe }}
                    </div>

                    <!-- Product Options -->
                    <form id="addToCartForm" method="POST" action="{% url 'store:add_to_cart' %}">
                        <input type="hidden" name="product_id" value="{{ product.id }}">

                        {% if product.colors %}
                            <div class="product-option">
                                <label>Цвет:</label>
                                <div class="option-buttons">
                                    {% for color in product.colors %}
                                        <label class="option-btn">
                                            <input type="radio" name="color" value="{{ color }}" {% if loop.first %}checked{% endif %}>
                                            <span>{{ color }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        {% if product.sizes %}
                            <div class="product-option">
                                <label>Размер:</label>
                                <div class="option-buttons">
                                    {% for size in product.sizes %}
                                        <label class="option-btn">
                                            <input type="radio" name="size" value="{{ size }}" {% if loop.first %}checked{% endif %}>
                                            <span>{{ size }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        <!-- Quantity -->
                        <div class="quantity-section">
                            <label>Количество:</label>
                            <div class="quantity-controls">
                                <button type="button" class="quantity-btn" onclick="changeQuantity(-1)">-</button>
                                <input type="number" name="quantity" value="1" min="1" max="{{ product.stock }}" id="quantityInput">
                                <button type="button" class="quantity-btn" onclick="changeQuantity(1)">+</button>
                            </div>
                            <span class="stock-info">В наличии: {{ product.stock }} шт.</span>
                        </div>

                        <!-- Add to Cart Button -->
                        <div class="product-actions">
                            {% if product.stock > 0 %}
                                <button type="submit" class="add-to-cart-btn">
                                    <i class="fas fa-shopping-cart"></i>
                                    Добавить в корзину
                                </button>
                            {% else %}
                                <button type="button" class="add-to-cart-btn disabled" disabled>
                                    Нет в наличии
                                </button>
                            {% endif %}
                            <button type="button" class="wishlist-btn" onclick="toggleWishlist({{ product.id }})">
                                <i class="far fa-heart"></i>
                                В избранное
                            </button>
                        </div>
                    </form>

                    <!-- Product Features -->
                    {% if product.features %}
                        <div class="product-features">
                            <h3>Особенности:</h3>
                            <ul>
                                {% for feature in product.features %}
                                    <li>{{ feature }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- Product Specifications -->
                    {% if product.specifications %}
                        <div class="product-specifications">
                            <h3>Характеристики:</h3>
                            <table>
                                {% for spec_name, spec_value in product.specifications.items() %}
                                    <tr>
                                        <td>{{ spec_name }}:</td>
                                        <td>{{ spec_value }}</td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Product Tabs -->
            <div class="product-tabs">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="showTab('description')">Описание</button>
                    <button class="tab-btn" onclick="showTab('specifications')">Характеристики</button>
                    <button class="tab-btn" onclick="showTab('care')">Уход</button>
                    <button class="tab-btn" onclick="showTab('delivery')">Доставка</button>
                </div>

                <div class="tab-content">
                    <div id="description" class="tab-pane active">
                        {{ product.full_description|default:product.description|safe }}
                    </div>
                    <div id="specifications" class="tab-pane">
                        {% if product.specifications %}
                            <table class="specifications-table">
                                {% for spec_name, spec_value in product.specifications.items() %}
                                    <tr>
                                        <td>{{ spec_name }}</td>
                                        <td>{{ spec_value }}</td>
                                    </tr>
                                {% endfor %}
                            </table>
                        {% else %}
                            <p>Характеристики не указаны</p>
                        {% endif %}
                    </div>
                    <div id="care" class="tab-pane">
                        {{ product.care_instructions|default:"<h4>Общие рекомендации по уходу за кожаными изделиями:</h4>
<ul>
    <li>Избегайте попадания влаги</li>
    <li>Храните в сухом месте</li>
    <li>Используйте специальные средства для ухода за кожей</li>
    <li>Избегайте прямых солнечных лучей</li>
</ul>"|safe }}
                    </div>
                    <div id="delivery" class="tab-pane">
                        <h4>Условия доставки:</h4>
                        <ul>
                            <li>Доставка по Москве - 300 ₽</li>
                            <li>Доставка по России - от 500 ₽</li>
                            <li>Бесплатная доставка при заказе от 10 000 ₽</li>
                            <li>Срок доставки: 1-3 рабочих дня</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Related Products -->
            {% if related_products %}
                <section class="related-products">
                    <h2>Похожие товары</h2>
                    <div class="products-grid">
                        {% for product in related_products %}
                            <div class="product-card" onclick="location.href='{% url 'store:product_detail' product.id %}'">
                                <div class="product-image">
                                    <img src="{{ product.image.url if product.image else url_for('static', filename='images/product-placeholder.jpg') }}" alt="{{ product.name }}">
                                </div>
                                <div class="product-info">
                                    <h3>{{ product.name }}</h3>
                                    <div class="product-price">
                                        <span class="price">{{ product.price|currency }}</span>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </section>
            {% endif %}
        </div>
    </section>
{% endblock %}

{% block extra_js %}
<script>
function changeMainImage(src, thumbnail) {
    document.getElementById('mainProductImage').src = src;
    document.querySelectorAll('.thumbnail').forEach(thumb => thumb.classList.remove('active'));
    thumbnail.classList.add('active');
}

function changeQuantity(delta) {
    const input = document.getElementById('quantityInput');
    let quantity = parseInt(input.value) + delta;
    const max = parseInt(input.max);

    if (quantity < 1) quantity = 1;
    if (quantity > max) quantity = max;

    input.value = quantity;
}

function showTab(tabName) {
    // Hide all tab panes
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });

    // Remove active class from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
}

function toggleWishlist(productId) {
    // Implement wishlist functionality
    console.log('Toggle wishlist for product:', productId);
}

// Handle form submission
document.getElementById('addToCartForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Товар добавлен в корзину', 'success');
            updateCartCount(data.cart_count);
        } else {
            showMessage(data.message || 'Ошибка при добавлении товара', 'error');
        }
    })
    .catch(error => {
        showMessage('Произошла ошибка', 'error');
    });
});
</script>
{% endblock %}
