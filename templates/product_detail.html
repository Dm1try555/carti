{% extends "base.html" %}
{% load static %}
{% load store_tags %}

{% block title %}{{ product.name }} - Carti_Leather{% endblock %}

{% block content %}
    <section class="product-detail">
        <div class="container">
            <!-- Хлібні крихти -->
            <nav class="breadcrumbs">
                <a href="{% url 'store:index' %}">Головна</a>
                <span>/</span>
                <a href="{% url 'store:catalog' %}">Каталог</a>
                {% if product.category %}
                    <span>/</span>
                    <a href="{% url 'store:catalog' %}?category={{ product.category.slug }}">{{ product.category.name }}</a>
                {% endif %}
                <span>/</span>
                <span>{{ product.name }}</span>
            </nav>

            <div class="product-detail-content">
                <!-- Зображення товару -->
                <div class="product-images">
                    <div class="main-image">
                        <img src="{% get_main_image product %}"
                             alt="{{ product.name }}" id="mainProductImage">
                    </div>
                    {% if product.images|length > 1 %}
                        <div class="thumbnail-images">
                            {% for image in product.images %}
                                <img src="{{ image.url }}" alt="{{ product.name }}"
                                     class="thumbnail {% if loop.first %}active{% endif %}"
                                     onclick="changeMainImage('{{ image.url }}', this)">
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Інформація про товар -->
                <div class="product-info">
                    <h1>{{ product.name }}</h1>

                    <div class="product-price">
                        {% if product.discount_price %}
                            <span class="current-price">{{ product.discount_price|currency }}</span>
                            <span class="old-price">{{ product.price|currency }}</span>
                            <span class="discount-badge">-{{ product.discount_percentage }}%</span>
                        {% else %}
                            <span class="current-price">{{ product.price|currency }}</span>
                        {% endif %}
                    </div>

                    <div class="product-description">
                        {{ product.description|safe }}
                    </div>

                    <!-- Опції товару -->
                    <form id="addToCartForm" method="POST" action="{% url 'store:add_to_cart' %}">
                        <input type="hidden" name="product_id" value="{{ product.id }}">

                        {% if product.colors %}
                            <div class="product-option">
                                <label>Колір:</label>
                                <div class="option-buttons">
                                    {% for color in product.colors %}
                                        <label class="option-btn">
                                            <input type="radio" name="color" value="{{ color }}" {% if loop.first %}checked{% endif %}>
                                            <span>{{ color }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        {% if product.sizes %}
                            <div class="product-option">
                                <label>Розмір:</label>
                                <div class="option-buttons">
                                    {% for size in product.sizes %}
                                        <label class="option-btn">
                                            <input type="radio" name="size" value="{{ size }}" {% if loop.first %}checked{% endif %}>
                                            <span>{{ size }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        <!-- Кількість -->
                        <div class="quantity-section">
                            <label>Кількість:</label>
                            <div class="quantity-controls">
                                <button type="button" class="quantity-btn" onclick="changeQuantity(-1)">-</button>
                                <input type="number" name="quantity" value="1" min="1" max="{{ product.stock }}" id="quantityInput">
                                <button type="button" class="quantity-btn" onclick="changeQuantity(1)">+</button>
                            </div>
                            <span class="stock-info">В наявності: {{ product.stock }} шт.</span>
                        </div>

                        <!-- Кнопка "Додати в корзину" -->
                        <div class="product-actions">
                            {% if product.stock > 0 %}
                                <button type="submit" class="add-to-cart-btn">
                                    <i class="fas fa-shopping-cart"></i>
                                    Додати в корзину
                                </button>
                            {% else %}
                                <button type="button" class="add-to-cart-btn disabled" disabled>
                                    Немає в наявності
                                </button>
                            {% endif %}
                            <button type="button" class="wishlist-btn" onclick="toggleWishlist({{ product.id }})">
                                <i class="far fa-heart"></i>
                                У вибране
                            </button>
                        </div>
                    </form>

                    <!-- Особливості товару -->
                    {% if product.features %}
                        <div class="product-features">
                            <h3>Особливості:</h3>
                            <ul>
                                {% for feature in product.features %}
                                    <li>{{ feature }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- Характеристики товару -->
                    {% if product.specifications %}
                        <div class="product-specifications">
                            <h3>Характеристики:</h3>
                            <table>
                                {% for spec_name, spec_value in product.specifications.items() %}
                                    <tr>
                                        <td>{{ spec_name }}:</td>
                                        <td>{{ spec_value }}</td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Вкладки товару -->
            <div class="product-tabs">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="showTab('description')">Опис</button>
                    <button class="tab-btn" onclick="showTab('specifications')">Характеристики</button>
                    <button class="tab-btn" onclick="showTab('care')">Догляд</button>
                    <button class="tab-btn" onclick="showTab('delivery')">Доставка</button>
                </div>

                <div class="tab-content">
                    <div id="description" class="tab-pane active">
                        {{ product.full_description|default:product.description|safe }}
                    </div>
                    <div id="specifications" class="tab-pane">
                        {% if product.specifications %}
                            <table class="specifications-table">
                                {% for spec_name, spec_value in product.specifications.items() %}
                                    <tr>
                                        <td>{{ spec_name }}</td>
                                        <td>{{ spec_value }}</td>
                                    </tr>
                                {% endfor %}
                            </table>
                        {% else %}
                            <p>Характеристики не вказані</p>
                        {% endif %}
                    </div>
                    <div id="care" class="tab-pane">
                        {{ product.care_instructions|default:"<h4>Загальні рекомендації по догляду за шкіряними виробами:</h4>
<ul>
    <li>Уникайте потрапляння вологи</li>
    <li>Зберігайте в сухому місці</li>
    <li>Використовуйте спеціальні засоби для догляду за шкірою</li>
    <li>Уникайте прямих сонячних променів</li>
</ul>"|safe }}
                    </div>
                    <div id="delivery" class="tab-pane">
                        <h4>Умови доставки:</h4>
                        <ul>
                            <li>Доставка по Москві – 300 ₽</li>
                            <li>Доставка по Росії – від 500 ₽</li>
                            <li>Безкоштовна доставка при замовленні від 10 000 ₽</li>
                            <li>Термін доставки: 1-3 робочі дні</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Схожі товари -->
            {% if related_products %}
                <section class="related-products">
                    <h2>Схожі товари</h2>
                    <div class="products-grid">
                        {% for product in related_products %}
                            <div class="product-card" onclick="location.href='{% url 'store:product_detail' product.id %}'">
                                <div class="product-image">
                                    <img src="{{ product.image.url if product.image else url_for('static', filename='images/product-placeholder.jpg') }}" alt="{{ product.name }}">
                                </div>
                                <div class="product-info">
                                    <h3>{{ product.name }}</h3>
                                    <div class="product-price">
                                        <span class="price">{{ product.price|currency }}</span>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </section>
            {% endif %}
        </div>
    </section>
{% endblock %}

{% block extra_js %}
<script>
function changeMainImage(src, thumbnail) {
    document.getElementById('mainProductImage').src = src;
    document.querySelectorAll('.thumbnail').forEach(thumb => thumb.classList.remove('active'));
    thumbnail.classList.add('active');
}

function changeQuantity(delta) {
    const input = document.getElementById('quantityInput');
    let quantity = parseInt(input.value) + delta;
    const max = parseInt(input.max);

    if (quantity < 1) quantity = 1;
    if (quantity > max) quantity = max;

    input.value = quantity;
}

function showTab(tabName) {
    // Приховати всі вкладки
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });

    // Зняти активність з усіх кнопок
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Показати вибрану вкладку
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
}

function toggleWishlist(productId) {
    // Функція додавання у вибране
    console.log('Перемикання вибраного для товару:', productId);
}

// Обробка відправлення форми
document.getElementById('addToCartForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Товар додано до корзини', 'success');
            updateCartCount(data.cart_count);
        } else {
            showMessage(data.message || 'Помилка при додаванні товару', 'error');
        }
    })
    .catch(error => {
        showMessage('Сталася помилка', 'error');
    });
});
</script>
{% endblock %}
